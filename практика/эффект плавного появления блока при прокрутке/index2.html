<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Документ</title>
<style>
    div {
        height: 80vh;
    }
    #first {
        background-color: #a3e635;
        opacity: var(--progress);
        transform: translateY(calc(10% - 10%*var(--progress, 0)));
    }
    #second {
        background-color: #f87171;
        opacity: var(--progress);
        transform: translateY(calc(10% - 10%*var(--progress, 0)));
    }
    #third {
        background-color: #38bdf8;
        opacity: var(--progress);
        transform: translateY(calc(10% - 10%*var(--progress, 0)));
    }
    #four {
        background-color: #f472b6;
        opacity: var(--progress);
        transform: translateY(calc(10% - 10%*var(--progress, 0)));
    }
</style>
</head>
<body>

<div style="height: 100vh;"></div>
<div id="first" class="item"></div>
<div id="second" class="item"></div>
<div id="third" class="item"></div>
<div id="four" class="item"></div>
<div style="height: 100vh;"></div>


<script>



        /******************Дребезжит, короче не работает**********************/



    function setProgress(elem){
		let percent = ((elem.getBoundingClientRect().height - ((window.scrollY + elem.getBoundingClientRect().bottom) - (window.scrollY + document.documentElement.clientHeight)))/elem.getBoundingClientRect().height)

		if(percent > 0 && percent < 1){
			let currentProgress = +(elem.style.getPropertyValue('--progress') || 0);
			currentProgress = +(currentProgress.toFixed(3))
			elem.style.setProperty('--progress', percent.toFixed(3))

			let id = setInterval(()=>{
				if(percent > currentProgress){

						let newProgress = (currentProgress += 0.01).toFixed(3)
						elem.style.setProperty('--progress', newProgress)


                } else {

					clearInterval(id)
                }

            }, 10)

		}
    }




	if(!!window.IntersectionObserver){
		let observer = new IntersectionObserver(((entries, observer) => {
			entries.forEach(entry => {
				if(entry.isIntersecting){
					window.addEventListener('scroll', ()=>{setProgress(entry.target)})
					observer.unobserve(entry.target)
				}
			})
		}))

		let items = document.querySelectorAll('div')
		items.forEach(item => { observer.observe(item) })
    }






</script>












</body>
</html>